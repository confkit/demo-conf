name: "tauri-desktop-macos"
description: "Tauri Desktop demo (macos)"

source:
  git_repo: "git@github.com:confkit/demo-tauri.git"
  git_branch: "main"
  language: "rust"
  manifest_file: "client/desktop/src-tauri/Cargo.toml"

environment:
  RUST_SRC_DIR: "client/desktop/src-tauri"
  # arm æ¶æ„ dmg æ–‡ä»¶
  ARM_DMG_FILE: "target/aarch64-apple-darwin/release/bundle/dmg/demo-tauri_0.1.0_aarch64.dmg"
  # x86 æ¶æ„ dmg æ–‡ä»¶
  X86_DMG_FILE: "target/x86_64-apple-darwin/release/bundle/dmg/demo-tauri_0.1.0_x86_64.dmg"
  # é€šç”¨ dmg æ–‡ä»¶
  UNIVERSAL_DMG_FILE: "target/universal-apple-darwin/release/bundle/dmg/demo-tauri_0.1.0_universal.dmg"

cleaner:
  workspace: false

# shell:
#   container: sh

steps:
  - name: "å…‹éš†é¡¹ç›®"
    commands:
      - "echo 'ğŸ” å…‹éš†é¡¹ç›®'"
      - "git clone ${GIT_REPO} -b main ${PROJECT_NAME}"
      - "chmod -R 777 ${PROJECT_NAME}"

  - name: "æ„å»ºåº”ç”¨ web (macos)"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}/client/web-app"
    commands:
      - "pnpm install"
      - "pnpm run build"

  - name: "æ„å»ºåº”ç”¨ desktop (macos)"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}/client/desktop"
    commands:
      - "pnpm check"
      - "pnpm run build:macos:arm64"

  - name: "å‡†å¤‡å‘å¸ƒç¯å¢ƒ"
    commands:
      - "echo å‡†å¤‡å‘å¸ƒ Rust Server v${PROJECT_VERSION} å¹¶åˆ›å»º GitHub Release"
      - "echo Git Hash: ${GIT_HASH}"
      - "echo Build Date: $(date -Iseconds)"
      - "echo Task ID: ${TASK_ID}"

  - name: "åˆ›å»º Release Notes"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}/client/desktop/src-tauri"
    commands:
      - "echo 'ğŸ“ åˆ›å»º Release Notes'"
      - "echo '### ğŸ—ï¸ Build Info' > RELEASE_NOTES.md"
      - "echo - **Version**: v${PROJECT_VERSION} >> RELEASE_NOTES.md"
      - "echo - **Git Hash**: ${GIT_HASH} >> RELEASE_NOTES.md"
      - "echo - **Build Time**: $(date -Iseconds) >> RELEASE_NOTES.md"
      - "echo - **Task ID**: ${TASK_ID} >> RELEASE_NOTES.md"
      - "echo '' >> RELEASE_NOTES.md"
      - "git cliff -o - --latest >> RELEASE_NOTES.md"

  # - name: "åˆ›å»º Gitee Release å¹¶ä¸Šä¼  macOS æ„å»ºæ–‡ä»¶"
  #   working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
  #   commands:
  #     - "echo 'ğŸ“¦ åˆ›å»º Gitee Release...'"
  #     - "gitee-release create v${PROJECT_VERSION} -m \"Tauri Desktop v${PROJECT_VERSION}\" -d \"$(cat client/desktop/src-tauri/RELEASE_NOTES.md | tr '\n' ' ')\""
  #     - "echo 'ğŸ“¤ ä¸Šä¼  macOS ç‰ˆæœ¬...'"
  #     - "gitee-release upload v${PROJECT_VERSION} ${ARM_DMG_FILE} -n 'demo-tauri-aarch64.dmg'"
  #     - "gitee-release upload v${PROJECT_VERSION} ${X86_DMG_FILE} -n 'demo-tauri-x86_64.dmg'"
  #     - "gitee-release upload v${PROJECT_VERSION} ${UNIVERSAL_DMG_FILE} -n 'demo-tauri-universal.dmg'"
  #     - "echo 'âœ… Gitee Release åˆ›å»ºå®Œæˆ: https://gitee.com/confkit/demo-tauri/releases/v${PROJECT_VERSION}'"
  #   timeout: 600

  - name: "åˆ›å»º GitHub Release å¹¶ä¸Šä¼  macOS æ„å»ºæ–‡ä»¶"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}/${RUST_SRC_DIR}"
    commands:
      - "echo 'ğŸ“¦ åˆ›å»º GitHub Release...'"
      - 'gh release create v${PROJECT_VERSION} --title "Tauri Desktop Demo v${PROJECT_VERSION}" --notes-file RELEASE_NOTES.md --draft'
      - "echo 'ğŸ“¤ ä¸Šä¼  macOS ARM64 ç‰ˆæœ¬...'"
      # ä¸Šä¼  arm64 dmg æ–‡ä»¶
      - "gh release upload v${PROJECT_VERSION} ${ARM_DMG_FILE} --clobber"
      # - "echo 'ğŸ“¤ ä¸Šä¼  macOS x86_64 ç‰ˆæœ¬...'"
      # - "gh release upload v${PROJECT_VERSION} ${X86_DMG_FILE} --clobber"
      # - "echo 'ğŸ“¤ ä¸Šä¼  macOS universal ç‰ˆæœ¬...'"
      # - "gh release upload v${PROJECT_VERSION} ${UNIVERSAL_DMG_FILE} --clobber"
      - "gh release edit v${PROJECT_VERSION} --draft=false"
      - "echo 'âœ… GitHub Release åˆ›å»ºå®Œæˆ: https://github.com/confkit/demo-tauri/releases/tag/v${PROJECT_VERSION}'"
    continue_on_error: true
    timeout: 300

  # - name: "ç§»é™¤ .git ç›®å½•"
  #   commands:
  #     - "rm -rf ${PROJECT_NAME}/.git"

  # - name: "æ‰§è¡Œ linux æµæ°´çº¿"
  #   commands:
  #     - ssh xiaoyown@10.14.206.32 "cd ~/projects/confkit/demo-conf && ../engine/target/release/confkit run --space demo-rust --project rust-cli-linux --hide-level"
