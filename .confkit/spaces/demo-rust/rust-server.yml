name: "rust-server"
description: "Rust Server demo"

source:
  git_repo: "git@github.com:confkit/demo-rust.git"
  git_branch: "main"
  language: "rust"
  manifest_file: "Cargo.toml"

environment:
  # è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ï¼ˆåŸºäºå†…ç½®å˜é‡ï¼‰
  BUILD_TARGET_DIR: "target/release"

cleaner:
  workspace: false

steps:
  - name: "å…‹éš†é¡¹ç›®"
    commands:
      - "echo 'ğŸ” å…‹éš†é¡¹ç›®'"
      - "git clone ${GIT_REPO} -b main ${PROJECT_NAME}"

  - name: "ä»£ç æ£€æŸ¥"
    container: "rust-builder-1.88"
    working_dir: "${CONTAINER_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "cargo fmt --check"
      - "cargo clippy --all-targets --all-features -- -D warnings"

  - name: "æ„å»ºåº”ç”¨(macos)"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "cargo make build-macos"

  - name: "æ„å»ºåº”ç”¨(linux.aarch64)"
    container: "rust-builder-1.88"
    working_dir: "${CONTAINER_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "cargo make build-aarch64-unknown-linux-gnu"

  - name: "å‡†å¤‡å‘å¸ƒç¯å¢ƒ"
    container: "rust-builder-1.88"
    commands:
      - "echo ' å‡†å¤‡å‘å¸ƒ Rust Server v${PROJECT_VERSION}'"
      - "echo 'Git Hash: ${GIT_HASH}'"
      - "echo 'Build Date: $(date -Iseconds)'"
      - "echo 'Task ID: ${TASK_ID}'"

  - name: "åˆ›å»º Release Notes"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "echo ğŸ“ åˆ›å»º Release Notes"
      - 'echo "### ğŸ—ï¸ Build Info" >> RELEASE_NOTES.md'
      - "echo - **Version**: v${PROJECT_VERSION} >> RELEASE_NOTES.md"
      - "echo - **Git Hash**: ${GIT_HASH} >> RELEASE_NOTES.md"
      - "echo - **Build Time**: $(date -Iseconds) >> RELEASE_NOTES.md"
      - "echo - **Task ID**: ${TASK_ID} >> RELEASE_NOTES.md"
      - "echo '' >> RELEASE_NOTES.md"

  - name: "è¿½åŠ  Release Notes"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "git cliff -o - --latest >> RELEASE_NOTES.md"

  - name: "é‡å‘½åäºŒè¿›åˆ¶æ–‡ä»¶"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "cp ./target/aarch64-apple-darwin/release/demo-rust ./target/demo-rust-aarch64-apple-darwin"
      - "cp ./target/x86_64-apple-darwin/release/demo-rust ./target/demo-rust-x86_64-apple-darwin"
      - "cp ./target/aarch64-unknown-linux-gnu/release/demo-rust ./target/demo-rust-aarch64-unknown-linux-gnu"

  - name: "å‘å¸ƒåˆ° GitHub Releases"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "echo 'ğŸ“¦ å‘å¸ƒåˆ° GitHub Releases'"
      - 'gh release create v${PROJECT_VERSION} --title "Rust Server Demo v${PROJECT_VERSION}" --notes-file RELEASE_NOTES.md --draft'
      - "echo 'ğŸ“¤ ä¸Šä¼  macOS ARM64 ç‰ˆæœ¬...'"
      - "gh release upload v${PROJECT_VERSION} ./target/demo-rust-aarch64-apple-darwin --clobber"
      - "echo 'ğŸ“¤ ä¸Šä¼  macOS x86_64 ç‰ˆæœ¬...'"
      - "gh release upload v${PROJECT_VERSION} ./target/demo-rust-x86_64-apple-darwin --clobber"
      - "echo 'ğŸ“¤ ä¸Šä¼  Linux ARM64 ç‰ˆæœ¬...'"
      - "gh release upload v${PROJECT_VERSION} ./target/demo-rust-aarch64-unknown-linux-gnu --clobber"
      - "gh release edit v${PROJECT_VERSION} --draft=false"
      - "echo 'âœ… GitHub Release åˆ›å»ºå®Œæˆ: https://github.com/confkit/demo-rust/releases/tag/v${PROJECT_VERSION}'"
    continue_on_error: true
    timeout: "5m"

  - name: "éªŒè¯å‘å¸ƒç»“æœ"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "echo 'ğŸ” éªŒè¯å‘å¸ƒç»“æœ'"
      - "gh release view v${PROJECT_VERSION} --json assets"
      - "echo 'âœ… å‘å¸ƒéªŒè¯å®Œæˆ'"
    continue_on_error: true
    timeout: "2m"

  - name: "ç§»é™¤ .git ç›®å½•"
    commands:
      - "rm -rf ${PROJECT_NAME}/.git"
