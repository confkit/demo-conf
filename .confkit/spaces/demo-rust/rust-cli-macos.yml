name: "rust-cli-macos"
description: "Rust Server demo"

source:
  git_repo: "git@github.com:confkit/demo-rust.git"
  git_branch: "main"
  language: "rust"
  manifest_file: "Cargo.toml"

environment:
  # 自定义环境变量（基于内置变量）
  BUILD_TARGET_DIR: "target/release"

cleaner:
  workspace: false

steps:
  - name: "克隆项目"
    commands:
      - "echo '🔍 克隆项目'"
      - "git clone ${GIT_REPO} -b main ${PROJECT_NAME}"
      - "chmod -R 777 ${PROJECT_NAME}"

  - name: "代码检查"
    container: "rust-builder-1.88"
    working_dir: "${CONTAINER_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "cargo fmt --check"
      - "cargo clippy --all-targets --all-features -- -D warnings"

  - name: "构建应用(macos)"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "cargo make build-macos"
      - "cp ./target/aarch64-apple-darwin/release/demo-rust ./target/demo-rust-aarch64-apple-darwin"
      - "cp ./target/x86_64-apple-darwin/release/demo-rust ./target/demo-rust-x86_64-apple-darwin"

  - name: "准备发布环境"
    container: "rust-builder-1.88"
    commands:
      - "echo ' 准备发布 Rust Server v${PROJECT_VERSION} 并创建 GitHub Release'"
      - "echo 'Git Hash: ${GIT_HASH}'"
      - "echo 'Build Date: $(date -Iseconds)'"
      - "echo 'Task ID: ${TASK_ID}'"

  - name: "创建 Release Notes"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "echo '📝 创建 Release Notes'"
      - 'echo "### 🏗️ Build Info" > RELEASE_NOTES.md'
      - "echo '- **Version**: v${PROJECT_VERSION}' >> RELEASE_NOTES.md"
      - "echo '- **Git Hash**: ${GIT_HASH}' >> RELEASE_NOTES.md"
      - "echo '- **Build Time**: $(date -Iseconds)' >> RELEASE_NOTES.md"
      - "echo '- **Task ID**: ${TASK_ID}' >> RELEASE_NOTES.md"
      - "echo '' >> RELEASE_NOTES.md"
      - "git cliff -o - --latest >> RELEASE_NOTES.md"

  - name: "创建 GitHub Release 并上传 macOS 构建文件"
    working_dir: "${HOST_WORKSPACE_DIR}/${PROJECT_NAME}"
    commands:
      - "echo '📦 创建 GitHub Release...'"
      - "gh release create v${PROJECT_VERSION} --title \"Rust Server Demo v${PROJECT_VERSION}\" --notes-file RELEASE_NOTES.md --draft"
      - "echo '📤 上传 macOS ARM64 版本...'"
      - "gh release upload v${PROJECT_VERSION} ./target/demo-rust-aarch64-apple-darwin --clobber"
      - "echo '📤 上传 macOS x86_64 版本...'"
      - "gh release upload v${PROJECT_VERSION} ./target/demo-rust-x86_64-apple-darwin --clobber"
      - "gh release edit v${PROJECT_VERSION} --draft=false"
      - "echo '✅ GitHub Release 创建完成: https://github.com/confkit/demo-rust/releases/tag/v${PROJECT_VERSION}'"
    continue_on_error: true
    timeout: "5m"

  - name: "移除 .git 目录"
    commands:
      - "rm -rf ${PROJECT_NAME}/.git"

  - name: "执行 linux 流水线"
    commands:
      - ssh xiaoyown@10.14.206.32 "cd ~/projects/confkit/demo-conf && ../engine/target/release/confkit run --space demo-rust --project rust-cli-linux --hide-level"
